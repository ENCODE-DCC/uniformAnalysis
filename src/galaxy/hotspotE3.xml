<tool id="hotspotE3" name="ENCODE3 hotspot regions" version="1.0">
    <description> and peaks calling.</description>
    <command interpreter="python">
        hotspotE3.py $bamInput $tagLen $bamMetric $hotOutput $peaksOutput $densityOutput $sample 
        $repNo ${name}U${__user_id__}
    </command>
    <version_command>python ../../../../tools/encode/hotspotE3.py --version</version_command>
    <stdio>
        <exit_code range="1:" level="fatal" description="Fatal error" />
        <regex match=".*" source="stderr" level="log" />
    </stdio>
    <inputs>
        <param name="bamInput" type="data" format="bam" label="Alignments file (bam)" />
        <param name="tagLen" type="select" label="Tag length">
            <option value="32" >32</option>
            <option value="36" >36</option>
            <option value="40" >40</option>
            <option value="50" selected="true">50</option>
            <option value="58" >58</option>
            <option value="72" >72</option>
            <option value="76" >76</option>
            <option value="100">100</option>
        </param>
        <param name="repNo" type="integer" value="1" label="Replicate" min="0" help="Numbers only">
        </param>
        <param name="sample" type="select" label="Full or Sampled bam">
            <option value="full" selected="true">Full</option>
            <option value="sample" >Sampled</option>
        </param>
        <param name="bamMetric" type="data" format="txt" label="Histogram metrics (txt)" />
        <param name="name" type="text" value="" size="40" optional="true" label="Analysis Name" 
               help="Letters and numbers only [optional]">
            <sanitizer invalid_char=""><valid initial="string.letters,string.digits"/></sanitizer>
        </param>
    </inputs>
    <outputs>
        <data format="bed" name="hotOutput"     label="${name}Rep${repNo} ${sample} Hotspots" />
        <data format="bed" name="peaksOutput"   label="${name}Rep${repNo} ${sample} Called Peaks" />
        <data format="bigWig" name="densityOutput" label="${name}Rep${repNo} ${sample} Density Signal" />
    </outputs>
    <help>
.. class:: warningmark

   Need to make dependency on "bam evaluation" output
   
.. class:: infomark

   Calls regions and peaks of elevated alignment from a bam file on GRCh37/hg19 reference genome.  
   An *ENCODE3 analysis* involves multiple steps and dataset replicates, of which this is one.
   Use *ENCODE3 workflows* to ensure that all analysis steps are performed in the proper sequence.

**Inputs:**
    The **Alignments file** is expected to be the generated output from a previous 
    *ENCODE3 fastQ alignment* step.  

    The **Histogram metrics** file is expected to be the generated output from a previous 
    *ENCODE3 bam evaluation* step.  

    The **Tag length** is the expected length (in bases) of read tags.  It is used in peak 
    calling to identify genomic regions that are unmappable in the reference genome.  If 
    the tag length is unknown, then examine the "Sequence Length Distribution" in the 
    *fastQ Stats* which is generated by the *ENCODE3 fastQ validation* step.

    The **Replicate** number allows combining multiple replicates into a single analysis.  If the 
    replicate number is not incremented then repeated steps will overwrite previous replicate 
    results.  Merged replicates should have a 0 (zero) replicate number. 

    Specify whether the input is a **Full or sampled bam** file.  Hotspots and peaks are generally 
    called from full bam files.  The ENCODE analysis, however, runs hotspots on the sampled bam, 
    which is output from a previous "bam evaluatation" step.

    The optional **Analysis Name** field will be used to tie multiple steps together into 
    one analysis, ensuring related files are well named and a single log records all processing 
    taken.  If the intention is to run multiple analyses, then providing an analysis name ensures 
    that results from one analyis are over-written by another.  Multiple histories for a single user 
    can share the same named analysis, but two separate users cannot.

**Outputs:**
    This step is expected to produce three files:
    
    - **Hotspots** or broad regions of high alignment.
    - **Called Peaks** or narrow regions of extremely high alignment threshholded at FDR 0.01.
    - **Density Signal** or the signal of alignment density used to call hotspots and peaks.
    
    The **log** of this single step can be seen under *view details* stdout.
    
    If the outputs are delivered to a location external to galaxy, the **Analysis log** covering 
    all steps of the analysis will be delivered to the same location.  Otherwise the log may be
    found in the directory pointed to by 'tmpDir' as defined in the settings file.

+--------+------------------------------------------------------------------------------------+
||encPng||All *ENCODE3 Analysis* steps provided through Galaxy are run via the same python    | 
|        |scripts and third-party tools as the official *ENCODE3 Analysis Pipeline*.  Just as | 
|        |with the official pipeline, all work is be performed in temporary directories and   |
|        |successful results moved to well-named locations.  If the initial input datasets are| 
|        |from a symlinked Galaxy library, results will be moved to the same directory as the |  
|        |inputs and then symlinked back into Galaxy. If the initial inputs do not have a     | 
|        |recognizable location outside the Galaxy database, then results will be written     |
|        |back into the Galaxy database as well.                                              |
+--------+------------------------------------------------------------------------------------+

.. |encPng| image:: http://genome.ucsc.edu/images/ENCODE_scaleup_logo.png
   :width: 100
    </help>
</tool>
